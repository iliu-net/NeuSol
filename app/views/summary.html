<?php
  Sc::ui_script('/app/views/summary.js');
  $graph = new phpGraph();
?>
<?= View::instance()->render('header.html') ?>
<div id="topdiv">
  <input type="hidden" id="base_url" name="base_url" value="<?= Sc::url('/rpt_summary/') ?>"/>
  Year: <input type="text" id="form_year" name="year" maxlength=4 size=4 pattern="[0-9]" value="<?=$year?>" onchange="chgrpt()"/><?= Sc::jslnk('chgrpt()','Go') ?>
</div>
<div id="bottom">
<h3><?=$year?> Summary</h3>

<table>
 <thead>
  <tr>
    <th>Category</th>
    <?php for ($i=1;$i<=12;$i++) { printf('<th>%02d</th>',$i); } ?>
    <th>Totals</th>
    <th>Percent</th>
  </tr>
 </thead>
 <tbody>
  <?php foreach (array_keys($category_types) as $tt) { ?>
   <tr><th colspan="15"><?= $category_types[$tt] ?></th></tr>
   <?php foreach (array_keys($table[0][$tt]) as $cat) { ?>
    <tr>
     <td style="color:darkgreen"><?=$categories_long[$cat]?></td>
     <?php for ($i=1;$i<=13;$i++) { $mn = $i == 13 ? 0 : $i; ?>
      <td align="right">
	<?php
	 if (count($table[$mn][$tt][$cat]) == 0) {
	   echo '&nbsp;';
	   $total = '';
	 } elseif (count($table[$mn][$tt][$cat]) == 1 && isset($table[$mn][$tt][$cat][0])) {
	   list($total) = $table[$mn][$tt][$cat];
	   if ($total < 0) {
	     echo '<span style="color:red">'.number_format($total,2).'</span>';
	   } else {
	     echo number_format($total,2);
	   }
	 } else {
	   $total = 0;
	   foreach ($table[$mn][$tt][$cat] as $x=>$y) {
	     $total += $y;
	   }
	   echo '<strong>';
	   if ($total < 0) {
	     echo '<span style="color:red">'.number_format($total,2).'</span>';
	   } else {
	     echo number_format($total,2);
	   }
	   echo '</strong>';
	   ksort($table[$mn][$tt][$cat]);
	   foreach ($table[$mn][$tt][$cat] as $x=>$z) {
	     echo '<br/>'.$x.': ';
	     if ($z < 0) {
	       echo '<span style="color:red">'.number_format($z,2).'</span>';
	     } else {
	       echo number_format($z,2);
	     }

	   }
	 }
	?>
      </td>
     <?php } ?>
     <?php
	 echo '<td align="right">';
	 if ($total != '') {
	   $pct = $total * 100.0 / $totals[0][$tt];
	   if ($total < 0) {
	     echo '<span style="color:red">'.number_format($pct,2).'</span>';
	   } else {
	     echo number_format($pct,2);
	   }
	   echo '%';
	 }
	 echo '</td>';
     ?>
    </tr>
   <?php } ?>
   <tr>
    <th>Total <?=  $category_types[$tt] ?></th>
     <?php for ($i=1;$i<=13;$i++) { $mn = $i == 13 ? 0 : $i; ?>
      <?php if ($totals[$mn][$tt] < 0) { ?>
      <th align="right" style="color:red"><?= number_format($totals[$mn][$tt],2) ?></th>
      <?php } else { ?>
      <th align="right" style="color:blue"><?= number_format($totals[$mn][$tt],2) ?></th>
      <?php } ?>
     <?php } ?>
     <td>&nbsp;</td>
   </tr>
   <tr>
    <th>Cumulative <?=  $category_types[$tt] ?></th>
     <?php $j = 0.0; for ($i=1;$i<=12;$i++) { $j += $totals[$i][$tt];?>
      <?php if ($j < 0) { ?>
      <th align="right" style="color:red"><?= number_format($j,2) ?></th>
      <?php } else { ?>
      <th align="right" style="color:blue"><?= number_format($j,2) ?></th>
      <?php } ?>
     <?php } ?>
     <td colspan="2">&nbsp;</td>
   </tr>
  <?php } ?>
 </tbody>
 <tfoot>
   <tr><th colspan="15"><hr/></th></tr>
   <tr>
    <th>Balance</th>
    <?php for ($i=1;$i<=13;$i++) { ?>
      <?php
	$mn = $i == 13 ? 0 : $i;
	$total = 0;
	foreach (array_keys($category_types) as $tt) {
	  $total += $totals[$mn][$tt];
	}
      ?>
      <?php if ($total < 0) { ?>
      <th align="right" style="color:red"><?=number_format($total)?></th>
      <?php } else { ?>
      <th align="right" style="color:blue"><?=number_format($total)?></th>
      <?php } ?>
    <?php } ?>
    <td>&nbsp;</td>
   </tr>
   <tr>
    <th>Cumulative Balance</th>
    <?php $j = 0.0; for ($i=1;$i<=12;$i++) { ?>
      <?php
	foreach (array_keys($category_types) as $tt) {
	  $j += $totals[$i][$tt];
	}
      ?>
      <?php if ($j < 0) { ?>
      <th align="right" style="color:red"><?=number_format($j)?></th>
      <?php } else { ?>
      <th align="right" style="color:blue"><?=number_format($j)?></th>
      <?php } ?>
    <?php } ?>
    <td colspan="2">&nbsp;</td>
   </tr>
 </tfoot>

</table>

</div>
<?= View::instance()->render('footer.html') ?>
<script src="<?= Sc::url('/ui/scripts/pikaday-helper.js')?>"></script>

